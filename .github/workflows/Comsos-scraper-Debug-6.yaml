name: Cosmos Gallery Debug 6

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *" # hourly

jobs:
  scrape:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    env:
      URLS: >
        https://www.cosmos.so/rlphoto/swim,
        https://www.cosmos.so/rlphoto/studio-tests,
        https://www.cosmos.so/rlphoto/studio-test-feminine,
        https://www.cosmos.so/rlphoto/swim-resort,
        https://www.cosmos.so/rlphoto/location-tests
      MAX_SCROLLS: 260
      WAIT_BETWEEN: 900
      FIRST_IDLE: 8000
      STABLE_CHECKS: 8
      PLAYWRIGHT_BROWSERS_PATH: /home/runner/.cache/ms-playwright

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          clean: true

      - name: Use Node.js 20 + cache npm
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: /home/runner/.cache/ms-playwright
          key: ms-playwright-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ms-playwright-${{ runner.os }}-

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright (Chromium + deps)
        run: npx playwright install --with-deps chromium

      - name: Scrape all Cosmos pages (with debug logs)
        shell: bash
        run: |
          set -euo pipefail

          IFS=',' read -ra arr <<< "${URLS}"
          mkdir -p public debug

          for u in "${arr[@]}"; do
            u="$(echo "$u" | xargs)"
            slug="$(basename "$u")"

            echo "============================================"
            echo "Scraping $u -> public/${slug}.json"
            echo "============================================"

            # Run scrape and capture stdout/stderr to debug log (do not fail job on one bad URL)
            set +e
            COSMOS_URL="$u" OUT_FILE="public/${slug}.json" \
              MAX_SCROLLS="${MAX_SCROLLS}" WAIT_BETWEEN="${WAIT_BETWEEN}" FIRST_IDLE="${FIRST_IDLE}" STABLE_CHECKS="${STABLE_CHECKS}" \
              node scraper/scrape.mjs >"debug/${slug}.log" 2>&1
            STATUS=$?
            set -e

            echo "Exit code: $STATUS"
            echo "Exit code: $STATUS" >>"debug/${slug}.log"

            # Ensure a json exists so the downstream steps don't explode
            if [ ! -f "public/${slug}.json" ]; then
              echo "{\"ok\":false,\"source\":\"$u\",\"count\":0,\"items\":[]}" > "public/${slug}.json"
              echo "Wrote fallback empty JSON for ${slug}" >>"debug/${slug}.log"
            fi

            # Print count in workflow logs
            COUNT="$(node -e "const j=require('./public/${slug}.json'); console.log((j.items||[]).length)" 2>/dev/null || echo 0)"
            echo "Item count for ${slug}: ${COUNT}"
            echo "Item count: ${COUNT}" >>"debug/${slug}.log"

            # Print first 10 items in workflow logs (no heredoc)
            node -e "try{const j=require('./public/${slug}.json'); (j.items||[]).slice(0,10).forEach((it,i)=>console.log((i+1)+':',it.type,it.src));}catch(e){console.log('preview failed',e.message)}" \
              >>"debug/${slug}.log" 2>&1

            # If low count, run an extra debug capture (screenshot + html) using a generated JS file (no heredoc)
            if [ "$COUNT" -le 2 ]; then
              echo "Low item count detected for ${slug}, capturing page debug (html + png)" | tee -a "debug/${slug}.log"

              DEBUG_JS="debug/_debug_${slug}.cjs"
              rm -f "$DEBUG_JS"

              printf '%s\n' \
                "const fs = require('fs');" \
                "const { chromium } = require('playwright');" \
                "(async () => {" \
                "  const url = process.env.COSMOS_URL;" \
                "  const slug = process.env.SLUG;" \
                "  const browser = await chromium.launch({ headless: true });" \
                "  const context = await browser.newContext({ viewport:{ width:1600, height:1000 }, deviceScaleFactor:2 });" \
                "  const page = await context.newPage();" \
                "  const failed = [];" \
                "  const logs = [];" \
                "  page.on('console', msg => logs.push('['+msg.type()+'] '+msg.text()));" \
                "  page.on('response', res => { if (res.status() >= 400) failed.push({ status: res.status(), url: res.url() }); });" \
                "  await page.goto(url, { waitUntil: 'domcontentloaded', timeout: 120000 });" \
                "  await page.waitForTimeout(8000);" \
                "  for (let i=0;i<6;i++){ await page.mouse.wheel(0,900); await page.waitForTimeout(900); }" \
                "  const metrics = await page.evaluate(() => {" \
                "    const root = document.querySelector('main') || document.body;" \
                "    let bg=0;" \
                "    root.querySelectorAll('*').forEach(el=>{ const b=getComputedStyle(el).backgroundImage; if (b && b.includes('url(')) bg++; });" \
                "    return { readyState: document.readyState, title: document.title || '', imgCount: root.querySelectorAll('img').length, videoCount: root.querySelectorAll('video').length, bgImageCount: bg };" \
                "  });" \
                "  fs.writeFileSync('debug/'+slug+'-metrics.json', JSON.stringify({ url, metrics, failed }, null, 2));" \
                "  fs.writeFileSync('debug/'+slug+'-console.txt', logs.join('\\n'));" \
                "  fs.writeFileSync('debug/'+slug+'.html', await page.content());" \
                "  await page.screenshot({ path: 'debug/'+slug+'.png', fullPage: true });" \
                "  await browser.close();" \
                "})();" \
                > "$DEBUG_JS"

              COSMOS_URL="$u" SLUG="$slug" node "$DEBUG_JS" >>"debug/${slug}.log" 2>&1 || true
            fi
          done

      - name: Upload debug artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cosmos-scrape-debug
          path: |
            debug/**
            public/*.json

      - name: Commit + push updated JSON
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add public/*.json
          git diff --cached --quiet || git commit -m "Update Cosmos gallery JSON"
          git push

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: gh-pages
